---
title: "Footballers' Nationalities"
author: "Gregory Vander Vinne"
date: "2023-10-14"
output:
  html_document:
    # code_folding: 'hide'
    toc: true
    toc_float: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Packages and Data, include=FALSE}
#Clear memory
rm(list = ls(all = TRUE))

#Load packages
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
  tidyverse,     # data management and visualization
  showtext,      # help with downloaded fonts  
  systemfonts,   # use downloaded fonts
  eurostat,      # get list of european countries  
  here,          # relative file pathways
  RColorBrewer,  # effective color palettes  
  rayshader,     # 3d plots
  colorspace,    # fancy work with colors like darken and lighten
  countrycode,   # iso codes and country names
  viridis,       # better map colors
  plotly,        # interactive plots
  worldfootballR # football statistics
)

#Download basic player-level stats from FbRef for 2020-21 to 2022-23 seasons
footballers <- fb_big5_advanced_season_stats(season_end_year= 2023, stat_type= "standard", team_or_player= "player")

#Load coutnry abbreviations matched to names so we can get full names
fifaCodes <- read.csv(here("Europe_Borders/Fifa_Country_Codes.csv"))

#Load world population data
popData <- world_bank_pop %>%
  mutate(Nation = countrycode(country, origin = "iso3c", destination="country.name.en")) %>% #Get country name from code
  filter(indicator == "SP.POP.TOTL") %>% #Take only total population
  select("Pop" = "2017", #Take most recent year available
         "Nation") %>%
  #Make some names match the names in the other datasets
  mutate(Nation = case_when(       
    Nation == "United Kingdom" ~ "UK", 
    Nation == "United States" ~ "USA",
    Nation == "Bosnia & Herzegovina" ~ "Bosnia and Herzegovina",
    Nation == "Ivory Coast" ~  "Côte d’Ivoire",
    Nation == "Czechia" ~ "Czech Republic",
    Nation == "Myanmar (Burma)" ~ "Myanmar",
    # Nation == "French Guiana" ~ "" #French guiana and DRC appear missing from pop data
    TRUE ~ Nation
    )
  )



#Load country polygons
borders <- map_data("world") %>%
  rename(Nation = region)

myPal <- brewer.pal("GnBu", n=9)

```

```{r Wrangle Data}

#Get number of players by nationality
natData <- footballers %>%
    mutate(Nation = case_when(
    Nation %in% c("ENG", "SCO","NIR", "WAL") ~ "UK", 
    TRUE ~ Nation
    )
  ) %>%
  group_by(Nation) %>%
  summarise(Count = n()) %>%
  #Give full country names
  rename(Nation_Code = Nation) %>%
  left_join(fifaCodes, by="Nation_Code") %>%
  mutate(Nation = case_when(
    Nation_Code == "UK" ~ "UK", 
    TRUE ~ Nation
    )
  ) %>%
  full_join(borders, by = "Nation") %>%
  left_join(popData, by = "Nation") %>%
  filter(Nation != "Antarctica")

#Replace NA player count with 0
natData$Count[is.na(natData$Count)] <- 0

tmp <- natData$Nation %>%
  unique() %>%
  as.data.frame()

```

```{r GGPlot Zoomed in On Europe}
#Plot ggplot of just europe
europe_gg <- ggplot(natData, aes(x=long, y=lat, group = group, fill = Count)) + 
  geom_polygon() + 
  coord_fixed(xlim = c(-15,25),
              ylim = c(35, 65))+
  scale_fill_distiller(palette = "Blues", direction = 1) +
  theme(
    plot.background = element_rect(fill  = "white"),
    panel.grid = element_blank(), 
    panel.background = element_blank(),
    axis.ticks = element_blank(),
    axis.title = element_blank(),
    # axis.text = element_blank()
  )

europe_gg


```

```{r GGPlot Log Scaled}
#PLot with log scale
europe_gg_log <- natData %>%
  ggplot(aes(x=long, y=lat, group = group, 
             # fill = Count/Pop*1000000+(0.01/1000000)
             fill = Count/Pop*1000000
             # fill = Count
             )) + 
    geom_polygon() + 
    # coord_fixed(xlim = c(-15,40),
    #             ylim = c(35, 65))+
    # scale_fill_distiller(palette = "Blues", direction = 1) +
    # scale_fill_gradientn(colours = myPal,
    #                     trans = "log", breaks = c(0.1,1,7),
    #                     name = "Players Per Million") +
    scale_fill_viridis(option = "magma",
                       breaks = c(0.0005, 0.05, 5), 
                       trans = scales::pseudo_log_trans(sigma = 0.001),
                       name = "Players Per Million Inhabitants",
                       labels = scales::scientific)+
    ggtitle("Where Are Footballers in the Top 5 Leagues From?",
            # subtitle = "\n"
            ) + 
    theme(
      #  plot.background = element_rect(fill  = lighten("#F7A072",0.8)),
      # legend.position = c(0.177,1.03),
      # legend.direction = "horizontal",
      # legend.margin = margin(0),
      # legend.background = element_rect(fill =myPal["back_color"]),
      legend.position = "bottom",
      panel.grid = element_blank(), 
      # panel.background = element_rect(fill  = lighten("#F7A072",0.8)),
      panel.background = element_rect(fill  = lighten("white",0.9)),
      axis.ticks = element_blank(),
      axis.title = element_blank(),
      axis.text = element_blank()
    )

europe_gg_log



```
```{r GGPlot Zoomed in On Europe and Log Scaled}
#PLot with log scale
europe_gg_log <- natData %>%
  ggplot(aes(x=long, y=lat, group = group, 
             fill = Count/Pop*1000000+(0.01/1000000)
             # fill = Count/Pop*1000000
             # fill = Count
             )) + 
    geom_polygon() + 
    # coord_fixed(xlim = c(-15,40),
    #             ylim = c(35, 65))+
    # scale_fill_distiller(palette = "Blues", direction = 1) +
    scale_fill_gradientn(colours = myPal,
                        trans = "log", breaks = c(0,0.0005,0.05,5),
                        name = "Players Per Million") +
    # scale_fill_viridis_c(breaks = c(0.005, 0.5, 5), 
    #                      trans = scales::pseudo_log_trans(sigma = 0.001),
    #                      name = "Players Per Million")+
    ggtitle("Where Are Footballers in the Top 5 Leagues From?") + 
    theme(
      #  plot.background = element_rect(fill  = lighten("#F7A072",0.8)),
      panel.grid = element_blank(), 
      # panel.background = element_rect(fill  = lighten("#F7A072",0.8)),
      panel.background = element_rect(fill  = lighten("#594f3b",0.9)),
      axis.ticks = element_blank(),
      axis.title = element_blank(),
      axis.text = element_blank()
    )

europe_gg_log



```
```{r 3D GGPlot Zoomed in On Europe}
 ggplotly(europe_gg)


```


# ```{r 3D GGPlot Zoomed in On Europe}
# 
# 
# plot_gg(europe_gg)
# 
# 
# ```





